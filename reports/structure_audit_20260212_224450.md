# 结构一致性强制核查报告

- 扫描时间：2026-02-12 22:54:04
- 扫描目录：`src/unluac/`
- Java文件总数：262
- 关键词命中文件数：45
- 报告路径：`reports/structure_audit_20260212_224450.md`

## 步骤1：源码扫描（证据）

### 1.1 关键词命中统计

| 关键词 | 命中文件数 | 命中次数 |
|---|---:|---:|
| `getItem` | 22 | 92 |
| `getSkill` | 3 | 9 |
| `reward` | 35 | 617 |
| `goal` | 33 | 409 |
| `fame` | 13 | 44 |
| `pvppoint` | 13 | 38 |
| `mileage` | 1 | 1 |
| `requstItem` | 2 | 7 |

### 1.2 涉及类清单
- `src/unluac\editor\QuestEditorFrame.java`
- `src/unluac\editor\QuestEditorModel.java`
- `src/unluac\editor\QuestEditorSaveResult.java`
- `src/unluac\editor\QuestEditorService.java`
- `src/unluac\editor\QuestReward.java`
- `src/unluac\editor\QuestRewardDiffDetector.java`
- `src/unluac\editor\QuestStageModel.java`
- `src/unluac\semantic\IndexedGoalAccessAstScanner.java`
- `src/unluac\semantic\NpcHardcodeRewriter.java`
- `src/unluac\semantic\PatternBFixer.java`
- `src/unluac\semantic\PatternFFixer.java`
- `src/unluac\semantic\Phase25QuestNpcDependencyMapper.java`
- `src/unluac\semantic\Phase2LucDataExtractionSystem.java`
- `src/unluac\semantic\Phase3DatabaseWriter.java`
- `src/unluac\semantic\Phase3DbConsistencyValidator.java`
- `src/unluac\semantic\Phase4QuestExportValidator.java`
- `src/unluac\semantic\Phase4QuestLucExporter.java`
- `src/unluac\semantic\Phase5NpcLucExporter.java`
- `src/unluac\semantic\Phase6BForcedHighReferenceMutationValidator.java`
- `src/unluac\semantic\Phase6CDbDrivenExportValidator.java`
- `src/unluac\semantic\Phase6DbMutationAndImpactValidator.java`
- `src/unluac\semantic\QuestFieldCoverageScanner.java`
- `src/unluac\semantic\QuestGetItemStructureRewriter.java`
- `src/unluac\semantic\QuestModificationAutoPropagator.java`
- `src/unluac\semantic\QuestModificationPropagationAnalyzer.java`
- `src/unluac\semantic\QuestModificationRiskValidator.java`
- `src/unluac\semantic\QuestNode.java`
- `src/unluac\semantic\QuestNpcDependencyScanner.java`
- `src/unluac\semantic\QuestNpcGraphBuilder.java`
- `src/unluac\semantic\QuestRuntimeAstMapper.java`
- `src/unluac\semantic\QuestRuntimeGoalSnapshot.java`
- `src/unluac\semantic\QuestRuntimeStateDemo.java`
- `src/unluac\semantic\QuestRuntimeStateMachine.java`
- `src/unluac\semantic\QuestSemanticCsvTool.java`
- `src/unluac\semantic\QuestSemanticExtractor.java`
- `src/unluac\semantic\QuestSemanticJson.java`
- `src/unluac\semantic\QuestSemanticModel.java`
- `src/unluac\semantic\QuestSemanticPatchApplier.java`
- `src/unluac\semantic\RuntimeConsistencyValidator.java`
- `src/unluac\semantic\RuntimeFailurePatternClassifier.java`
- `src/unluac\web\controller\AdminController.java`
- `src/unluac\web\result\AdminQuestDetail.java`
- `src/unluac\web\result\AdminQuestListItem.java`
- `src/unluac\web\service\AdminQuestService.java`
- `src/unluac\web\support\AdminRecentModifiedService.java`

### 1.3 文件级证据（路径/类/方法/源码片段）

#### 文件：`src/unluac\editor\QuestEditorFrame.java`
- 类名：`QuestEditorFrame`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 40）：
```java
   38: import unluac.semantic.KillRequirement;
   39: import unluac.semantic.NpcScriptModel;
   40: import unluac.semantic.QuestGoal;
   41: import unluac.semantic.ScriptTypeDetector;
   42: 
```
- 相关代码片段（行 70）：
```java
   68: 
   69:   private final JTextField needLevelField = new JTextField();
   70:   private final JTextArea goalItemsArea = new JTextArea();
   71:   private final JTextArea goalMonstersArea = new JTextArea();
   72: 
```
- 相关代码片段（行 71）：
```java
   69:   private final JTextField needLevelField = new JTextField();
   70:   private final JTextArea goalItemsArea = new JTextArea();
   71:   private final JTextArea goalMonstersArea = new JTextArea();
   72: 
   73:   private final JTextField rewardExpField = new JTextField();
```

#### 文件：`src/unluac\editor\QuestEditorModel.java`
- 类名：`QuestEditorModel`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 7）：
```java
    5: 
    6: import unluac.semantic.QuestDialogTree;
    7: import unluac.semantic.QuestGoal;
    8: 
    9: public class QuestEditorModel {
```
- 相关代码片段（行 15）：
```java
   13:   public String description;
   14: 
   15:   public int rewardExp;
   16:   public int rewardFame;
   17:   public int rewardMoney;
```
- 相关代码片段（行 16）：
```java
   14: 
   15:   public int rewardExp;
   16:   public int rewardFame;
   17:   public int rewardMoney;
   18:   public int rewardPvppoint;
```

#### 文件：`src/unluac\editor\QuestEditorSaveResult.java`
- 类名：`QuestEditorSaveResult`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 12）：
```java
   10:   public String mappingPath;
   11:   public String validationSummary;
   12:   public String rewardDiffSummary;
   13: }
```

#### 文件：`src/unluac\editor\QuestEditorService.java`
- 类名：`QuestEditorService`
- 方法名：`<class-level-or-init>, loadFromLuc`
- 相关代码片段（行 30）：
```java
   28: import unluac.semantic.ItemRequirement;
   29: import unluac.semantic.KillRequirement;
   30: import unluac.semantic.QuestGoal;
   31: 
   32: public class QuestEditorService {
```
- 相关代码片段（行 62）：
```java
   60:     Map<Integer, Map<String, String>> boundFieldValueByQuest = collectBoundStringValues(extraction.fieldBindings);
   61:     Map<Integer, Map<Integer, String>> dialogLineFieldByQuest = collectDialogLineFieldMap(extraction.fieldBindings);
   62:     Map<Integer, QuestReward> rewardByQuest = buildEditorRewardByQuest(extraction.quests);
   63: 
   64:     List<QuestEditorModel> out = new ArrayList<QuestEditorModel>();
```
- 相关代码片段（行 71）：
```java
   69:       model.description = row.description;
   70: 
   71:       QuestReward reward = rewardByQuest.get(Integer.valueOf(row.questId));
   72:       if(reward == null) {
   73:         reward = new QuestReward();
```

#### 文件：`src/unluac\editor\QuestReward.java`
- 类名：`QuestReward`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 8）：
```java
    6: import java.util.Map;
    7: 
    8: public class QuestReward {
    9: 
   10:   public int exp;
```
- 相关代码片段（行 11）：
```java
    9: 
   10:   public int exp;
   11:   public int fame;
   12:   public int money;
   13:   public int pvppoint;
```
- 相关代码片段（行 13）：
```java
   11:   public int fame;
   12:   public int money;
   13:   public int pvppoint;
   14:   public final List<ItemReward> items = new ArrayList<ItemReward>();
   15:   public final List<Integer> skillIds = new ArrayList<Integer>();
```

#### 文件：`src/unluac\editor\QuestRewardDiffDetector.java`
- 类名：`QuestRewardDiffDetector`
- 方法名：`<class-level-or-init>, detect`
- 相关代码片段（行 8）：
```java
    6: import java.util.Objects;
    7: 
    8: public class QuestRewardDiffDetector {
    9: 
   10:   public QuestRewardDiffReport detect(QuestReward before, QuestReward after) {
```
- 相关代码片段（行 10）：
```java
    8: public class QuestRewardDiffDetector {
    9: 
   10:   public QuestRewardDiffReport detect(QuestReward before, QuestReward after) {
   11:     QuestReward left = before == null ? new QuestReward() : before;
   12:     QuestReward right = after == null ? new QuestReward() : after;
```
- 相关代码片段（行 11）：
```java
    9: 
   10:   public QuestRewardDiffReport detect(QuestReward before, QuestReward after) {
   11:     QuestReward left = before == null ? new QuestReward() : before;
   12:     QuestReward right = after == null ? new QuestReward() : after;
   13: 
```

#### 文件：`src/unluac\editor\QuestStageModel.java`
- 类名：`QuestStageModel`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 6）：
```java
    4: import java.util.List;
    5: 
    6: import unluac.semantic.QuestGoal;
    7: 
    8: public class QuestStageModel {
```
- 相关代码片段（行 25）：
```java
   23:   public int completionDialogLineIndex = -1;
   24: 
   25:   public QuestGoal goal = new QuestGoal();
   26:   public QuestReward reward = new QuestReward();
   27: }
```
- 相关代码片段（行 26）：
```java
   24: 
   25:   public QuestGoal goal = new QuestGoal();
   26:   public QuestReward reward = new QuestReward();
   27: }
```

#### 文件：`src/unluac\semantic\IndexedGoalAccessAstScanner.java`
- 类名：`IndexedGoalAccessAstScanner`
- 方法名：`<class-level-or-init>, main`
- 相关代码片段（行 25）：
```java
   23: import java.util.Set;
   24: 
   25: public class IndexedGoalAccessAstScanner {
   26: 
   27:   private static final Charset UTF8 = Charset.forName("UTF-8");
```
- 相关代码片段（行 35）：
```java
   33:     Path output = args.length >= 2
   34:         ? Paths.get(args[1])
   35:         : Paths.get("reports", "indexed_goal_access_full_scan.json");
   36: 
   37:     IndexedGoalAccessAstScanner scanner = new IndexedGoalAccessAstScanner();
```
- 相关代码片段（行 37）：
```java
   35:         : Paths.get("reports", "indexed_goal_access_full_scan.json");
   36: 
   37:     IndexedGoalAccessAstScanner scanner = new IndexedGoalAccessAstScanner();
   38:     ScanReport report = scanner.scan(inputDir, output);
   39: 
```

#### 文件：`src/unluac\semantic\NpcHardcodeRewriter.java`
- 类名：`NpcHardcodeRewriter`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 30）：
```java
   28:   private static final Charset UTF8 = Charset.forName("UTF-8");
   29: 
   30:   private static final Pattern SIMPLE_GETITEM_REF = Pattern.compile(
   31:       "qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*(id|count)");
   32: 
```
- 相关代码片段（行 31）：
```java
   29: 
   30:   private static final Pattern SIMPLE_GETITEM_REF = Pattern.compile(
   31:       "qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*(id|count)");
   32: 
   33:   private static final Pattern CHECK_ITEM_PAIR = Pattern.compile(
```
- 相关代码片段（行 34）：
```java
   32: 
   33:   private static final Pattern CHECK_ITEM_PAIR = Pattern.compile(
   34:       "CHECK_ITEM_CNT\\s*\\(\\s*qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*id\\s*\\)\\s*([<>]=?)\\s*qt\\s*\\[\\s*\\1\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\2\\s*\\]\\s*\\.\\s*count");
   35: 
   36:   private static final Pattern DUPLICATED_HAS_ALL_ITEMS_AND = Pattern.compile(
```

#### 文件：`src/unluac\semantic\PatternBFixer.java`
- 类名：`PatternBFixer`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 32）：
```java
   30: 
   31:   private static final Pattern CHECK_ITEM_PAIR = Pattern.compile(
   32:       "CHECK_ITEM_CNT\\s*\\(\\s*qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*id\\s*\\)\\s*([<>]=?)\\s*qt\\s*\\[\\s*\\1\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\2\\s*\\]\\s*\\.\\s*count",
   33:       Pattern.CASE_INSENSITIVE);
   34:   private static final Pattern GETITEM_ID = Pattern.compile(
```
- 相关代码片段（行 34）：
```java
   32:       "CHECK_ITEM_CNT\\s*\\(\\s*qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*id\\s*\\)\\s*([<>]=?)\\s*qt\\s*\\[\\s*\\1\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\2\\s*\\]\\s*\\.\\s*count",
   33:       Pattern.CASE_INSENSITIVE);
   34:   private static final Pattern GETITEM_ID = Pattern.compile(
   35:       "qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*id",
   36:       Pattern.CASE_INSENSITIVE);
```
- 相关代码片段（行 35）：
```java
   33:       Pattern.CASE_INSENSITIVE);
   34:   private static final Pattern GETITEM_ID = Pattern.compile(
   35:       "qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*id",
   36:       Pattern.CASE_INSENSITIVE);
   37:   private static final Pattern GETITEM_COUNT = Pattern.compile(
```

#### 文件：`src/unluac\semantic\PatternFFixer.java`
- 类名：`PatternFFixer`
- 方法名：`<class-level-or-init>, transformLine`
- 相关代码片段（行 30）：
```java
   28: 
   29:   private static final Pattern KILL_MONSTER_PAIR = Pattern.compile(
   30:       "qData\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*killMonster\\s*\\[\\s*qt\\s*\\[\\s*\\1\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*killMonster\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*id\\s*\\]\\s*>=\\s*qt\\s*\\[\\s*\\1\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*killMonster\\s*\\[\\s*\\2\\s*\\]\\s*\\.\\s*count",
   31:       Pattern.CASE_INSENSITIVE);
   32:   private static final Pattern KILL_MONSTER_INDEX_ACCESS = Pattern.compile(
```
- 相关代码片段（行 33）：
```java
   31:       Pattern.CASE_INSENSITIVE);
   32:   private static final Pattern KILL_MONSTER_INDEX_ACCESS = Pattern.compile(
   33:       "qt\\s*\\[\\s*(\\d+)\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*killMonster\\s*\\[\\s*\\d+\\s*\\]\\s*\\.(id|count)",
   34:       Pattern.CASE_INSENSITIVE);
   35: 
```
- 相关代码片段（行 245）：
```java
  243:         continue;
  244:       }
  245:       String replacement = "__QUEST_HAS_ALL_KILL_TARGETS(qt[" + questId + "].goal.killMonster)";
  246:       matcher.appendReplacement(sb, Matcher.quoteReplacement(replacement));
  247:     }
```

#### 文件：`src/unluac\semantic\Phase25QuestNpcDependencyMapper.java`
- 类名：`Phase25QuestNpcDependencyMapper`
- 方法名：`build`
- 相关代码片段（行 142）：
```java
  140:       }
  141: 
  142:       if("goal.getItem".equals(accessType)) {
  143:         if(quest != null) {
  144:           quest.goalGetItemAccessCount++;
```
- 相关代码片段（行 144）：
```java
  142:       if("goal.getItem".equals(accessType)) {
  143:         if(quest != null) {
  144:           quest.goalGetItemAccessCount++;
  145:         }
  146:         npc.goalGetItemAccessCount++;
```
- 相关代码片段（行 146）：
```java
  144:           quest.goalGetItemAccessCount++;
  145:         }
  146:         npc.goalGetItemAccessCount++;
  147:       } else if("goal.killMonster".equals(accessType)) {
  148:         if(quest != null) {
```

#### 文件：`src/unluac\semantic\Phase2LucDataExtractionSystem.java`
- 类名：`Phase2LucDataExtractionSystem`
- 方法名：`main, run, extractQuestData`
- 相关代码片段（行 80）：
```java
   78:     System.out.println("totalQuestCount=" + result.questData.totalQuestCount);
   79:     System.out.println("totalQuestReferences=" + result.npcIndex.totalQuestReferences);
   80:     System.out.println("totalGoalIndexedAccess=" + result.summary.totalGoalIndexedAccessDetected);
   81:   }
   82: 
```
- 相关代码片段（行 114）：
```java
  112:     out.summary.totalFilesScanned = out.summary.totalNpcFilesScanned + (out.summary.questFileDetected ? 1 : 0);
  113:     out.summary.totalQuestReferencesDetected = out.npcIndex.totalQuestReferences;
  114:     out.summary.totalGoalIndexedAccessDetected = out.npcIndex.totalGoalIndexedAccess;
  115: 
  116:     ensureParent(questOut);
```
- 相关代码片段（行 166）：
```java
  164:       }
  165: 
  166:       record.needLevel = model.goal == null ? 0 : model.goal.needLevel;
  167:       Integer bq = bQLoopByQuest.get(Integer.valueOf(model.questId));
  168:       record.bQLoop = bq == null ? 0 : bq.intValue();
```

#### 文件：`src/unluac\semantic\Phase3DatabaseWriter.java`
- 类名：`Phase3DatabaseWriter`
- 方法名：`main`
- 相关代码片段（行 69）：
```java
   67:     System.out.println("summaryOutput=" + summaryOutput.toAbsolutePath());
   68:     System.out.println("totalQuestInserted=" + summary.totalQuestInserted);
   69:     System.out.println("totalGoalGetItemRows=" + summary.totalGoalGetItemRows);
   70:     System.out.println("totalGoalKillMonsterRows=" + summary.totalGoalKillMonsterRows);
   71:     System.out.println("totalGoalMeetNpcRows=" + summary.totalGoalMeetNpcRows);
```
- 相关代码片段（行 70）：
```java
   68:     System.out.println("totalQuestInserted=" + summary.totalQuestInserted);
   69:     System.out.println("totalGoalGetItemRows=" + summary.totalGoalGetItemRows);
   70:     System.out.println("totalGoalKillMonsterRows=" + summary.totalGoalKillMonsterRows);
   71:     System.out.println("totalGoalMeetNpcRows=" + summary.totalGoalMeetNpcRows);
   72:     System.out.println("totalRewardItemRows=" + summary.totalRewardItemRows);
```
- 相关代码片段（行 71）：
```java
   69:     System.out.println("totalGoalGetItemRows=" + summary.totalGoalGetItemRows);
   70:     System.out.println("totalGoalKillMonsterRows=" + summary.totalGoalKillMonsterRows);
   71:     System.out.println("totalGoalMeetNpcRows=" + summary.totalGoalMeetNpcRows);
   72:     System.out.println("totalRewardItemRows=" + summary.totalRewardItemRows);
   73:     System.out.println("totalNpcReferenceRows=" + summary.totalNpcReferenceRows);
```

#### 文件：`src/unluac\semantic\Phase3DbConsistencyValidator.java`
- 类名：`Phase3DbConsistencyValidator`
- 方法名：`validate`
- 相关代码片段（行 97）：
```java
   95:       compareField(report, row.questId, "needLevel", Integer.valueOf(row.needLevel), Integer.valueOf(actual.needLevel));
   96:       compareField(report, row.questId, "bqLoop", Integer.valueOf(row.bqLoop), Integer.valueOf(actual.bqLoop));
   97:       compareField(report, row.questId, "rewardExp", Integer.valueOf(row.rewardExp), Integer.valueOf(actual.rewardExp));
   98:       compareField(report, row.questId, "rewardGold", Integer.valueOf(row.rewardGold), Integer.valueOf(actual.rewardGold));
   99: 
```
- 相关代码片段（行 98）：
```java
   96:       compareField(report, row.questId, "bqLoop", Integer.valueOf(row.bqLoop), Integer.valueOf(actual.bqLoop));
   97:       compareField(report, row.questId, "rewardExp", Integer.valueOf(row.rewardExp), Integer.valueOf(actual.rewardExp));
   98:       compareField(report, row.questId, "rewardGold", Integer.valueOf(row.rewardGold), Integer.valueOf(actual.rewardGold));
   99: 
  100:       compareStringList(report, row.questId, "contents", row.contents, actual.contents);
```
- 相关代码片段（行 104）：
```java
  102:       compareStringList(report, row.questId, "info", row.info, actual.info);
  103: 
  104:       comparePairList(report, row.questId, "goal.getItem", row.goalGetItem, actual.goalGetItem);
  105:       comparePairList(report, row.questId, "goal.killMonster", row.goalKillMonster, actual.goalKillMonster);
  106:       compareIntList(report, row.questId, "goal.meetNpc", row.goalMeetNpc, actual.goalMeetNpc);
```

#### 文件：`src/unluac\semantic\Phase4QuestExportValidator.java`
- 类名：`Phase4QuestExportValidator`
- 方法名：`validate`
- 相关代码片段（行 96）：
```java
   94:       compareScalar(result, questId, "needLevel", source.needLevel, target.needLevel);
   95:       compareScalar(result, questId, "bQLoop", source.bqLoop, target.bqLoop);
   96:       compareScalar(result, questId, "reward.exp", source.rewardExp, target.rewardExp);
   97:       compareScalar(result, questId, "reward.gold", source.rewardGold, target.rewardGold);
   98: 
```
- 相关代码片段（行 97）：
```java
   95:       compareScalar(result, questId, "bQLoop", source.bqLoop, target.bqLoop);
   96:       compareScalar(result, questId, "reward.exp", source.rewardExp, target.rewardExp);
   97:       compareScalar(result, questId, "reward.gold", source.rewardGold, target.rewardGold);
   98: 
   99:       compareStringList(result, questId, "contents", source.contents, target.contents);
```
- 相关代码片段（行 103）：
```java
  101:       compareStringList(result, questId, "info", source.info, target.info);
  102: 
  103:       comparePairList(result, questId, "goal.getItem", source.goalGetItem, target.goalGetItem);
  104:       comparePairList(result, questId, "goal.killMonster", source.goalKillMonster, target.goalKillMonster);
  105:       compareIntegerList(result, questId, "goal.meetNpc", source.goalMeetNpc, target.goalMeetNpc);
```

#### 文件：`src/unluac\semantic\Phase4QuestLucExporter.java`
- 类名：`Phase4QuestLucExporter`
- 方法名：`<class-level-or-init>, loadFromDb`
- 相关代码片段（行 26）：
```java
   24:  *
   25:  * <p>所属链路：链路 B（DB -> semantic model -> 导出 lua -> 导出 luc -> 客户端读取）的 quest 分支。</p>
   26:  * <p>输入：`ghost_game` 中 quest 相关表（quest_main/goal/reward 等）。</p>
   27:  * <p>输出：`phase4_exported_quest.lua`。</p>
   28:  * <p>数据库副作用：无（只读）。</p>
```
- 相关代码片段（行 120）：
```java
  118: 
  119:     try(Connection connection = DriverManager.getConnection(jdbcUrl, user, password)) {
  120:       String mainSql = "SELECT quest_id, name, need_level, bq_loop, reward_exp, reward_gold "
  121:           + "FROM quest_main ORDER BY quest_id ASC";
  122:       try(PreparedStatement ps = connection.prepareStatement(mainSql);
```
- 相关代码片段（行 134）：
```java
  132:           record.needLevel = toNullableInt(rs, "need_level");
  133:           record.bqLoop = toNullableInt(rs, "bq_loop");
  134:           record.rewardExp = toNullableInt(rs, "reward_exp");
  135:           record.rewardGold = toNullableInt(rs, "reward_gold");
  136:           byQuest.put(Integer.valueOf(record.questId), record);
```

#### 文件：`src/unluac\semantic\Phase5NpcLucExporter.java`
- 类名：`Phase5NpcLucExporter`
- 方法名：`export`
- 相关代码片段（行 126）：
```java
  124:     summary.dbNpcReferenceRows = db.npcReferenceRows;
  125:     summary.dbOrphanReferenceRows = db.orphanReferenceRows;
  126:     summary.dbGoalGetItemRows = db.goalGetItemRows;
  127:     summary.dbGoalKillMonsterRows = db.goalKillMonsterRows;
  128:     summary.dbGoalMeetNpcRows = db.goalMeetNpcRows;
```
- 相关代码片段（行 127）：
```java
  125:     summary.dbOrphanReferenceRows = db.orphanReferenceRows;
  126:     summary.dbGoalGetItemRows = db.goalGetItemRows;
  127:     summary.dbGoalKillMonsterRows = db.goalKillMonsterRows;
  128:     summary.dbGoalMeetNpcRows = db.goalMeetNpcRows;
  129:     summary.dbRewardItemRows = db.rewardItemRows;
```
- 相关代码片段（行 128）：
```java
  126:     summary.dbGoalGetItemRows = db.goalGetItemRows;
  127:     summary.dbGoalKillMonsterRows = db.goalKillMonsterRows;
  128:     summary.dbGoalMeetNpcRows = db.goalMeetNpcRows;
  129:     summary.dbRewardItemRows = db.rewardItemRows;
  130: 
```

#### 文件：`src/unluac\semantic\Phase6BForcedHighReferenceMutationValidator.java`
- 类名：`Phase6BForcedHighReferenceMutationValidator`
- 方法名：`mutateDatabase`
- 相关代码片段（行 192）：
```java
  190:       try {
  191:         String updateName = "UPDATE quest_main SET name = CONCAT(COALESCE(name,''), ?) WHERE quest_id = ?";
  192:         String updateReward = "UPDATE quest_reward_item SET item_count = item_count + 2 WHERE quest_id = ? ORDER BY seq_index ASC LIMIT 1";
  193:         String insertReward = "INSERT INTO quest_reward_item(quest_id, seq_index, item_id, item_count) VALUES(?,?,?,?)";
  194:         String updateContent = "UPDATE quest_contents SET text = CONCAT(COALESCE(text,''), ?) WHERE quest_id = ? AND seq_index = 0";
```
- 相关代码片段（行 193）：
```java
  191:         String updateName = "UPDATE quest_main SET name = CONCAT(COALESCE(name,''), ?) WHERE quest_id = ?";
  192:         String updateReward = "UPDATE quest_reward_item SET item_count = item_count + 2 WHERE quest_id = ? ORDER BY seq_index ASC LIMIT 1";
  193:         String insertReward = "INSERT INTO quest_reward_item(quest_id, seq_index, item_id, item_count) VALUES(?,?,?,?)";
  194:         String updateContent = "UPDATE quest_contents SET text = CONCAT(COALESCE(text,''), ?) WHERE quest_id = ? AND seq_index = 0";
  195: 
```
- 相关代码片段（行 197）：
```java
  195: 
  196:         try(PreparedStatement psName = connection.prepareStatement(updateName);
  197:             PreparedStatement psReward = connection.prepareStatement(updateReward);
  198:             PreparedStatement psInsertReward = connection.prepareStatement(insertReward);
  199:             PreparedStatement psContent = connection.prepareStatement(updateContent)) {
```

#### 文件：`src/unluac\semantic\Phase6CDbDrivenExportValidator.java`
- 类名：`Phase6CDbDrivenExportValidator`
- 方法名：`pickQuestForMutation, applyDatabaseMutation`
- 相关代码片段（行 115）：
```java
  113:     String sql = "SELECT DISTINCT qm.quest_id "
  114:         + "FROM quest_main qm "
  115:         + "INNER JOIN quest_reward_item qri ON qri.quest_id = qm.quest_id "
  116:         + "ORDER BY qm.quest_id ASC";
  117:     try(Connection connection = DriverManager.getConnection(DEFAULT_JDBC, DEFAULT_USER, DEFAULT_PASSWORD);
```
- 相关代码片段（行 136）：
```java
  134:       try {
  135:         String updateName = "UPDATE quest_main SET name = CONCAT(COALESCE(name,''), ?) WHERE quest_id = ?";
  136:         String updateReward = "UPDATE quest_reward_item SET item_count = item_count + 5 WHERE quest_id = ? ORDER BY seq_index ASC LIMIT 1";
  137: 
  138:         try(PreparedStatement psName = connection.prepareStatement(updateName);
```
- 相关代码片段（行 139）：
```java
  137: 
  138:         try(PreparedStatement psName = connection.prepareStatement(updateName);
  139:             PreparedStatement psReward = connection.prepareStatement(updateReward)) {
  140:           psName.setString(1, DB_ONLY_MARK);
  141:           psName.setInt(2, questId);
```

#### 文件：`src/unluac\semantic\Phase6DbMutationAndImpactValidator.java`
- 类名：`Phase6DbMutationAndImpactValidator`
- 方法名：`mutateDatabase`
- 相关代码片段（行 111）：
```java
  109:             + "FROM quest_main qm "
  110:             + "WHERE EXISTS (SELECT 1 FROM quest_contents qc WHERE qc.quest_id = qm.quest_id AND qc.seq_index = 0) "
  111:             + "AND EXISTS (SELECT 1 FROM quest_reward_item qri WHERE qri.quest_id = qm.quest_id) "
  112:             + "ORDER BY qm.quest_id ASC";
  113: 
```
- 相关代码片段（行 135）：
```java
  133: 
  134:         String updateName = "UPDATE quest_main SET name = CONCAT(COALESCE(name,''), ?) WHERE quest_id = ?";
  135:         String updateReward = "UPDATE quest_reward_item SET item_count = item_count + 1 WHERE quest_id = ? ORDER BY seq_index ASC LIMIT 1";
  136:         String updateContent = "UPDATE quest_contents SET text = CONCAT(COALESCE(text,''), ?) WHERE quest_id = ? AND seq_index = 0";
  137: 
```
- 相关代码片段（行 139）：
```java
  137: 
  138:         try(PreparedStatement psName = connection.prepareStatement(updateName);
  139:             PreparedStatement psReward = connection.prepareStatement(updateReward);
  140:             PreparedStatement psContent = connection.prepareStatement(updateContent)) {
  141: 
```

#### 文件：`src/unluac\semantic\QuestFieldCoverageScanner.java`
- 类名：`QuestFieldCoverageScanner`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 23）：
```java
   21: 
   22:   private static final List<String> EDITOR_QUEST_FIELDS = Arrays.asList(
   23:       "id", "name", "contents", "answer", "info", "npcsay", "needLevel", "needQuest", "goal", "reward", "requstItem");
   24:   private static final List<String> EDITOR_GOAL_FIELDS = Arrays.asList(
   25:       "getItem", "killMonster", "id", "itemid", "itemcnt", "count", "meetcnt", "monsterid", "killcount");
```
- 相关代码片段（行 24）：
```java
   22:   private static final List<String> EDITOR_QUEST_FIELDS = Arrays.asList(
   23:       "id", "name", "contents", "answer", "info", "npcsay", "needLevel", "needQuest", "goal", "reward", "requstItem");
   24:   private static final List<String> EDITOR_GOAL_FIELDS = Arrays.asList(
   25:       "getItem", "killMonster", "id", "itemid", "itemcnt", "count", "meetcnt", "monsterid", "killcount");
   26:   private static final List<String> EDITOR_REWARD_FIELDS = Arrays.asList(
```
- 相关代码片段（行 25）：
```java
   23:       "id", "name", "contents", "answer", "info", "npcsay", "needLevel", "needQuest", "goal", "reward", "requstItem");
   24:   private static final List<String> EDITOR_GOAL_FIELDS = Arrays.asList(
   25:       "getItem", "killMonster", "id", "itemid", "itemcnt", "count", "meetcnt", "monsterid", "killcount");
   26:   private static final List<String> EDITOR_REWARD_FIELDS = Arrays.asList(
   27:       "exp", "fame", "money", "pvppoint", "getItem", "getSkill", "id", "itemid", "count", "itemcnt");
```

#### 文件：`src/unluac\semantic\QuestGetItemStructureRewriter.java`
- 类名：`QuestGetItemStructureRewriter`
- 方法名：`<class-level-or-init>, main`
- 相关代码片段（行 28）：
```java
   26: import java.util.regex.Pattern;
   27: 
   28: public class QuestGetItemStructureRewriter {
   29: 
   30:   private static final Charset UTF8 = Charset.forName("UTF-8");
```
- 相关代码片段（行 33）：
```java
   31:   private static final Set<String> TARGET_CLUSTERS = new LinkedHashSet<String>(Arrays.asList("X1", "X2", "X3"));
   32:   private static final Pattern INDEXED_ACCESS_PATTERN = Pattern.compile(
   33:       "qt\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*(id|count)",
   34:       Pattern.CASE_INSENSITIVE);
   35:   private static final Pattern HELPER_DEF_PATTERN = Pattern.compile(
```
- 相关代码片段（行 58）：
```java
   56:         : Paths.get("reports", "rewrite_round_7A_stats.json");
   57: 
   58:     QuestGetItemStructureRewriter rewriter = new QuestGetItemStructureRewriter();
   59:     RewriteStats stats = rewriter.rewrite(clusterReport, sourceDir, outputDir, diffOut, statsOut);
   60: 
```

#### 文件：`src/unluac\semantic\QuestModificationAutoPropagator.java`
- 类名：`QuestModificationAutoPropagator`
- 方法名：`buildConsistencyResult`
- 相关代码片段（行 118）：
```java
  116:       }
  117:       for(QuestNpcDependencyScanner.AccessEntry access : entries) {
  118:         result.remainingHardcodedGoalIndexes.add(file + ":line=" + access.line + ":index=" + access.index);
  119:       }
  120:     }
```
- 相关代码片段（行 129）：
```java
  127:     }
  128: 
  129:     if(!result.remainingHardcodedGoalIndexes.isEmpty() || !result.brokenReferences.isEmpty()) {
  130:       result.validationStatus = "FAIL";
  131:     } else {
```
- 相关代码片段（行 139）：
```java
  137:     Collections.sort(result.unmatchedQuestIds, String.CASE_INSENSITIVE_ORDER);
  138:     Collections.sort(result.brokenReferences, String.CASE_INSENSITIVE_ORDER);
  139:     Collections.sort(result.remainingHardcodedGoalIndexes, String.CASE_INSENSITIVE_ORDER);
  140:     return result;
  141:   }
```

#### 文件：`src/unluac\semantic\QuestModificationPropagationAnalyzer.java`
- 类名：`QuestModificationPropagationAnalyzer`
- 方法名：`isRewriteRequired`
- 相关代码片段（行 150）：
```java
  148:     }
  149:     if(hasType(modificationTypes, "QUEST_ID_CHANGED")
  150:         || hasType(modificationTypes, "GOAL_DELETED")
  151:         || hasType(modificationTypes, "REWARD_DELETED")) {
  152:       return true;
```
- 相关代码片段（行 151）：
```java
  149:     if(hasType(modificationTypes, "QUEST_ID_CHANGED")
  150:         || hasType(modificationTypes, "GOAL_DELETED")
  151:         || hasType(modificationTypes, "REWARD_DELETED")) {
  152:       return true;
  153:     }
```
- 相关代码片段（行 154）：
```java
  152:       return true;
  153:     }
  154:     if(hasType(modificationTypes, "GOAL_ITEM_COUNT_CHANGED") || hasType(modificationTypes, "REWARD_STRUCTURE_CHANGED")) {
  155:       return relation != null && (relation.hasRole("GOAL_VERIFY") || relation.hasRole("REWARD_TRIGGER") || relation.hasRole("STATE_ADVANCE"));
  156:     }
```

#### 文件：`src/unluac\semantic\QuestModificationRiskValidator.java`
- 类名：`QuestModificationRiskValidator`
- 方法名：`<class-level-or-init>, detectQuestDeltas`
- 相关代码片段（行 16）：
```java
   14: import unluac.chunk.LuaChunk;
   15: import unluac.editor.QuestEditorModel;
   16: import unluac.editor.QuestReward;
   17: 
   18: public class QuestModificationRiskValidator {
```
- 相关代码片段（行 165）：
```java
  163:       }
  164: 
  165:       QuestGoal beforeGoal = before.goal == null ? new QuestGoal() : before.goal;
  166:       QuestGoal afterGoal = row.goal == null ? new QuestGoal() : row.goal;
  167:       if(before.goal != null && row.goal == null) {
```
- 相关代码片段（行 166）：
```java
  164: 
  165:       QuestGoal beforeGoal = before.goal == null ? new QuestGoal() : before.goal;
  166:       QuestGoal afterGoal = row.goal == null ? new QuestGoal() : row.goal;
  167:       if(before.goal != null && row.goal == null) {
  168:         delta.modificationTypes.add("goal_deleted");
```

#### 文件：`src/unluac\semantic\QuestNode.java`
- 类名：`QuestNode`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 10）：
```java
    8: 
    9:   public int questId;
   10:   public QuestGoal goal = new QuestGoal();
   11:   public final List<QuestSemanticModel.Reward> reward = new ArrayList<QuestSemanticModel.Reward>();
   12:   public int needLevel;
```
- 相关代码片段（行 11）：
```java
    9:   public int questId;
   10:   public QuestGoal goal = new QuestGoal();
   11:   public final List<QuestSemanticModel.Reward> reward = new ArrayList<QuestSemanticModel.Reward>();
   12:   public int needLevel;
   13:   public final List<String> referencedNpcFiles = new ArrayList<String>();
```

#### 文件：`src/unluac\semantic\QuestNpcDependencyScanner.java`
- 类名：`QuestNpcDependencyScanner`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 27）：
```java
   25:   private static final Pattern QDATA_PATTERN = Pattern.compile("\\bqData\\s*\\[\\s*(\\d+)\\s*\\]");
   26:   private static final Pattern SET_QUEST_STATE_PATTERN = Pattern.compile("\\bSET_QUEST_STATE\\s*\\(\\s*(\\d+)\\s*,");
   27:   private static final Pattern GOAL_GET_ITEM_PATTERN = Pattern.compile("^\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]");
   28:   private static final Pattern GOAL_KILL_MONSTER_PATTERN = Pattern.compile("^\\s*\\.\\s*goal\\s*\\.\\s*killMonster\\s*\\[\\s*(\\d+)\\s*\\]");
   29:   private static final Pattern NEED_LEVEL_PATTERN = Pattern.compile("^\\s*\\.\\s*needLevel\\b");
```
- 相关代码片段（行 28）：
```java
   26:   private static final Pattern SET_QUEST_STATE_PATTERN = Pattern.compile("\\bSET_QUEST_STATE\\s*\\(\\s*(\\d+)\\s*,");
   27:   private static final Pattern GOAL_GET_ITEM_PATTERN = Pattern.compile("^\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*(\\d+)\\s*\\]");
   28:   private static final Pattern GOAL_KILL_MONSTER_PATTERN = Pattern.compile("^\\s*\\.\\s*goal\\s*\\.\\s*killMonster\\s*\\[\\s*(\\d+)\\s*\\]");
   29:   private static final Pattern NEED_LEVEL_PATTERN = Pattern.compile("^\\s*\\.\\s*needLevel\\b");
   30:   private static final Pattern REWARD_PATTERN = Pattern.compile("^\\s*\\.\\s*reward\\b");
```
- 相关代码片段（行 30）：
```java
   28:   private static final Pattern GOAL_KILL_MONSTER_PATTERN = Pattern.compile("^\\s*\\.\\s*goal\\s*\\.\\s*killMonster\\s*\\[\\s*(\\d+)\\s*\\]");
   29:   private static final Pattern NEED_LEVEL_PATTERN = Pattern.compile("^\\s*\\.\\s*needLevel\\b");
   30:   private static final Pattern REWARD_PATTERN = Pattern.compile("^\\s*\\.\\s*reward\\b");
   31: 
   32:   private static final Charset UTF8 = Charset.forName("UTF-8");
```

#### 文件：`src/unluac\semantic\QuestNpcGraphBuilder.java`
- 类名：`QuestNpcGraphBuilder`
- 方法名：`loadDependencyIndex, loadPropagation`
- 相关代码片段（行 170）：
```java
  168:             }
  169: 
  170:             if(hardcodedIndex && "goal.getItem".equalsIgnoreCase(type)) {
  171:               npcNode.addHardcodedGoalIndex(index);
  172:             }
```
- 相关代码片段（行 171）：
```java
  169: 
  170:             if(hardcodedIndex && "goal.getItem".equalsIgnoreCase(type)) {
  171:               npcNode.addHardcodedGoalIndex(index);
  172:             }
  173:           }
```
- 相关代码片段（行 269）：
```java
  267:     for(NpcNode npcNode : graph.npcNodes.values()) {
  268:       if(npcNode.riskLevel == null || npcNode.riskLevel.isEmpty()) {
  269:         npcNode.riskLevel = npcNode.hardcodedGoalIndexes.isEmpty() ? "LOW" : "HIGH";
  270:       }
  271:     }
```

#### 文件：`src/unluac\semantic\QuestRuntimeAstMapper.java`
- 类名：`QuestRuntimeAstMapper`
- 方法名：`buildAstMappingSummary`
- 相关代码片段（行 79）：
```java
   77:     sb.append(";contentsCount=").append(model.dialogLines == null ? 0 : model.dialogLines.size());
   78:     sb.append(";answerPrefixCount=").append(countAnswerPrefix(model.dialogLines));
   79:     sb.append(";goalItems=").append(model.goal == null ? 0 : model.goal.items.size());
   80:     sb.append(";goalMonsters=").append(model.goal == null ? 0 : model.goal.monsters.size());
   81:     sb.append(";rewards=").append(model.rewards == null ? 0 : model.rewards.size());
```
- 相关代码片段（行 80）：
```java
   78:     sb.append(";answerPrefixCount=").append(countAnswerPrefix(model.dialogLines));
   79:     sb.append(";goalItems=").append(model.goal == null ? 0 : model.goal.items.size());
   80:     sb.append(";goalMonsters=").append(model.goal == null ? 0 : model.goal.monsters.size());
   81:     sb.append(";rewards=").append(model.rewards == null ? 0 : model.rewards.size());
   82:     return sb.toString();
```
- 相关代码片段（行 81）：
```java
   79:     sb.append(";goalItems=").append(model.goal == null ? 0 : model.goal.items.size());
   80:     sb.append(";goalMonsters=").append(model.goal == null ? 0 : model.goal.monsters.size());
   81:     sb.append(";rewards=").append(model.rewards == null ? 0 : model.rewards.size());
   82:     return sb.toString();
   83:   }
```

#### 文件：`src/unluac\semantic\QuestRuntimeGoalSnapshot.java`
- 类名：`QuestRuntimeGoalSnapshot`
- 方法名：`<class-level-or-init>, getItemCount`
- 相关代码片段（行 6）：
```java
    4: import java.util.Map;
    5: 
    6: public class QuestRuntimeGoalSnapshot {
    7: 
    8:   public int playerLevel;
```
- 相关代码片段（行 12）：
```java
   10:   private final Map<Integer, Integer> killCounts = new HashMap<Integer, Integer>();
   11: 
   12:   public QuestRuntimeGoalSnapshot() {
   13:     this.playerLevel = 0;
   14:   }
```
- 相关代码片段（行 20）：
```java
   18:   }
   19: 
   20:   public int getItemCount(int itemId) {
   21:     Integer value = this.itemCounts.get(Integer.valueOf(itemId));
   22:     return value == null ? 0 : value.intValue();
```

#### 文件：`src/unluac\semantic\QuestRuntimeStateDemo.java`
- 类名：`QuestRuntimeStateDemo`
- 方法名：`main`
- 相关代码片段（行 39）：
```java
   37:     }
   38: 
   39:     QuestRuntimeGoalSnapshot goal = new QuestRuntimeGoalSnapshot();
   40:     goal.playerLevel = Math.max(1, model.goal == null ? 1 : model.goal.needLevel);
   41:     if(model.goal != null) {
```
- 相关代码片段（行 40）：
```java
   38: 
   39:     QuestRuntimeGoalSnapshot goal = new QuestRuntimeGoalSnapshot();
   40:     goal.playerLevel = Math.max(1, model.goal == null ? 1 : model.goal.needLevel);
   41:     if(model.goal != null) {
   42:       for(ItemRequirement item : model.goal.items) {
```
- 相关代码片段（行 41）：
```java
   39:     QuestRuntimeGoalSnapshot goal = new QuestRuntimeGoalSnapshot();
   40:     goal.playerLevel = Math.max(1, model.goal == null ? 1 : model.goal.needLevel);
   41:     if(model.goal != null) {
   42:       for(ItemRequirement item : model.goal.items) {
   43:         goal.setItemCount(item.itemId, item.itemCount);
```

#### 文件：`src/unluac\semantic\QuestRuntimeStateMachine.java`
- 类名：`QuestRuntimeStateMachine`
- 方法名：`<class-level-or-init>, apply`
- 相关代码片段（行 12）：
```java
   10:   public static final int STATE_DIALOG = 1;
   11:   public static final int STATE_CHOICE = 2;
   12:   public static final int STATE_GOAL_CHECK = 3;
   13:   public static final int STATE_REWARD_PENDING = 4;
   14:   public static final int STATE_FINISHED = 5;
```
- 相关代码片段（行 13）：
```java
   11:   public static final int STATE_CHOICE = 2;
   12:   public static final int STATE_GOAL_CHECK = 3;
   13:   public static final int STATE_REWARD_PENDING = 4;
   14:   public static final int STATE_FINISHED = 5;
   15: 
```
- 相关代码片段（行 50）：
```java
   48:       QuestSemanticModel model,
   49:       int action,
   50:       QuestRuntimeGoalSnapshot goalSnapshot) {
   51:     if(current == null) {
   52:       throw new IllegalStateException("state is null");
```

#### 文件：`src/unluac\semantic\QuestSemanticCsvTool.java`
- 类名：`QuestSemanticCsvTool`
- 方法名：`<class-level-or-init>, printUsage`
- 相关代码片段（行 21）：
```java
   19: 
   20:   public static final String CSV_HEADER =
   21:       "quest_id,title,description,pre_quest_ids,reward_exp,reward_item_id,reward_item_count,reward_skill_ids,dialog_lines_json,condition_json";
   22: 
   23:   public static void main(String[] args) throws Exception {
```
- 相关代码片段（行 236）：
```java
  234:     public String description;
  235:     public List<Integer> preQuestIds = new ArrayList<Integer>();
  236:     public int rewardExp;
  237:     public List<Integer> rewardItemId = new ArrayList<Integer>();
  238:     public List<Integer> rewardItemCount = new ArrayList<Integer>();
```
- 相关代码片段（行 237）：
```java
  235:     public List<Integer> preQuestIds = new ArrayList<Integer>();
  236:     public int rewardExp;
  237:     public List<Integer> rewardItemId = new ArrayList<Integer>();
  238:     public List<Integer> rewardItemCount = new ArrayList<Integer>();
  239:     public List<Integer> rewardSkillIds = new ArrayList<Integer>();
```

#### 文件：`src/unluac\semantic\QuestSemanticExtractor.java`
- 类名：`QuestSemanticExtractor`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 28）：
```java
   26:   private static final String RULE_DESCRIPTION = "R-DESCRIPTION";
   27:   private static final String RULE_PREQUEST = "R-PREQUEST";
   28:   private static final String RULE_REWARD = "R-REWARD";
   29:   private static final String RULE_DIALOG = "R-DIALOG";
   30:   private static final String RULE_CONDITION = "R-CONDITION";
```
- 相关代码片段（行 38）：
```java
   36:   private static final Set<String> QUEST_KEYS = new LinkedHashSet<String>();
   37:   private static final Set<String> DIALOG_KEYS = new LinkedHashSet<String>();
   38:   private static final Set<String> REWARD_KEYS = new LinkedHashSet<String>();
   39:   private static final Set<String> CONDITION_KEYS = new LinkedHashSet<String>();
   40: 
```
- 相关代码片段（行 50）：
```java
   48:     QUEST_KEYS.add("needLevel");
   49:     QUEST_KEYS.add("needQuest");
   50:     QUEST_KEYS.add("goal");
   51:     QUEST_KEYS.add("reward");
   52:     QUEST_KEYS.add("requstItem");
```

#### 文件：`src/unluac\semantic\QuestSemanticJson.java`
- 类名：`QuestSemanticJson`
- 方法名：`appendQuest`
- 相关代码片段（行 63）：
```java
   61:     sb.append(indent).append("  \"preQuestIds\": ").append(toJsonArrayInt(model.preQuestIds)).append(",\n");
   62: 
   63:     sb.append(indent).append("  \"rewards\": [\n");
   64:     for(int i = 0; i < model.rewards.size(); i++) {
   65:       QuestSemanticModel.Reward reward = model.rewards.get(i);
```
- 相关代码片段（行 64）：
```java
   62: 
   63:     sb.append(indent).append("  \"rewards\": [\n");
   64:     for(int i = 0; i < model.rewards.size(); i++) {
   65:       QuestSemanticModel.Reward reward = model.rewards.get(i);
   66:       if(i > 0) {
```
- 相关代码片段（行 65）：
```java
   63:     sb.append(indent).append("  \"rewards\": [\n");
   64:     for(int i = 0; i < model.rewards.size(); i++) {
   65:       QuestSemanticModel.Reward reward = model.rewards.get(i);
   66:       if(i > 0) {
   67:         sb.append(",\n");
```

#### 文件：`src/unluac\semantic\QuestSemanticModel.java`
- 类名：`QuestSemanticModel`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 14）：
```java
   12:   public String description;
   13:   public final List<Integer> preQuestIds = new ArrayList<Integer>();
   14:   public final List<Reward> rewards = new ArrayList<Reward>();
   15:   public final List<String> dialogLines = new ArrayList<String>();
   16:   public QuestDialogTree dialogTree = new QuestDialogTree();
```
- 相关代码片段（行 17）：
```java
   15:   public final List<String> dialogLines = new ArrayList<String>();
   16:   public QuestDialogTree dialogTree = new QuestDialogTree();
   17:   public QuestGoal goal = new QuestGoal();
   18:   public final Map<String, Object> conditions = new LinkedHashMap<String, Object>();
   19:   public final Map<String, Object> completionConditions = new LinkedHashMap<String, Object>();
```
- 相关代码片段（行 21）：
```java
   19:   public final Map<String, Object> completionConditions = new LinkedHashMap<String, Object>();
   20: 
   21:   public static final class Reward {
   22:     public String type;
   23:     public int id;
```

#### 文件：`src/unluac\semantic\QuestSemanticPatchApplier.java`
- 类名：`QuestSemanticPatchApplier`
- 方法名：`decidePatchAction`
- 相关代码片段（行 165）：
```java
  163:           next = edited.dialogLines.get(index.intValue());
  164:         }
  165:       } else if(binding.fieldKey != null && binding.fieldKey.startsWith("reward_extra.")) {
  166:         String extraKey = binding.fieldKey.substring("reward_extra.".length());
  167:         Object value = edited.conditions == null ? null : edited.conditions.get("reward_extra_fields");
```
- 相关代码片段（行 166）：
```java
  164:         }
  165:       } else if(binding.fieldKey != null && binding.fieldKey.startsWith("reward_extra.")) {
  166:         String extraKey = binding.fieldKey.substring("reward_extra.".length());
  167:         Object value = edited.conditions == null ? null : edited.conditions.get("reward_extra_fields");
  168:         if(value instanceof Map<?, ?>) {
```
- 相关代码片段（行 167）：
```java
  165:       } else if(binding.fieldKey != null && binding.fieldKey.startsWith("reward_extra.")) {
  166:         String extraKey = binding.fieldKey.substring("reward_extra.".length());
  167:         Object value = edited.conditions == null ? null : edited.conditions.get("reward_extra_fields");
  168:         if(value instanceof Map<?, ?>) {
  169:           @SuppressWarnings("unchecked")
```

#### 文件：`src/unluac\semantic\RuntimeConsistencyValidator.java`
- 类名：`RuntimeConsistencyValidator`
- 方法名：`validate, validateNoHardcodedIndexes`
- 相关代码片段（行 76）：
```java
   74:     validateNpcReferencedQuestIds(graph, report);
   75:     validateRiskLevelThreshold(graph, report);
   76:     validateRewardStructureConsistency(propagationV2Path, report);
   77: 
   78:     report.failedCount = report.failureDetails.size();
```
- 相关代码片段（行 90）：
```java
   88:   private void validateNoHardcodedIndexes(QuestNpcDependencyGraph graph, ValidationReport report) {
   89:     for(NpcNode npcNode : graph.npcNodes.values()) {
   90:       if(npcNode == null || npcNode.hardcodedGoalIndexes == null || npcNode.hardcodedGoalIndexes.isEmpty()) {
   91:         continue;
   92:       }
```
- 相关代码片段（行 94）：
```java
   92:       }
   93:       FailureDetail detail = new FailureDetail();
   94:       detail.rule = "RULE_1_NO_HARDCODED_GOAL_INDEX";
   95:       detail.entityType = "NPC";
   96:       detail.entityId = npcNode.filePath;
```

#### 文件：`src/unluac\semantic\RuntimeFailurePatternClassifier.java`
- 类名：`RuntimeFailurePatternClassifier`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 30）：
```java
   28: 
   29:   private static final Pattern PATTERN_A = Pattern.compile(
   30:       "qt\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\d+\\s*\\](?!\\s*\\.)",
   31:       Pattern.CASE_INSENSITIVE);
   32:   private static final Pattern PATTERN_B = Pattern.compile(
```
- 相关代码片段（行 33）：
```java
   31:       Pattern.CASE_INSENSITIVE);
   32:   private static final Pattern PATTERN_B = Pattern.compile(
   33:       "qt\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*(id|count)\\b",
   34:       Pattern.CASE_INSENSITIVE);
   35:   private static final Pattern PATTERN_C = Pattern.compile(
```
- 相关代码片段（行 36）：
```java
   34:       Pattern.CASE_INSENSITIVE);
   35:   private static final Pattern PATTERN_C = Pattern.compile(
   36:       "\\blocal\\s+\\w+\\s*=\\s*qt\\s*\\[\\s*\\d+\\s*\\]\\s*\\.\\s*goal\\s*\\.\\s*getItem\\b",
   37:       Pattern.CASE_INSENSITIVE);
   38:   private static final Pattern PATTERN_D = Pattern.compile(
```

#### 文件：`src/unluac\web\controller\AdminController.java`
- 类名：`AdminController`
- 方法名：`dashboard`
- 相关代码片段（行 58）：
```java
   56:       out.questCount = queryCount(connection, "SELECT COUNT(*) FROM quest_main");
   57:       out.npcCount = queryCount(connection, "SELECT COUNT(DISTINCT npcFile) FROM npc_text_edit_map");
   58:       out.itemCount = queryCount(connection, "SELECT COUNT(*) FROM quest_reward_item");
   59:       out.mapCount = queryCount(connection, "SELECT COUNT(DISTINCT npc_file) FROM npc_quest_reference");
   60:       out.fashionCount = queryCount(connection, "SELECT COUNT(*) FROM quest_goal_getitem");
```
- 相关代码片段（行 60）：
```java
   58:       out.itemCount = queryCount(connection, "SELECT COUNT(*) FROM quest_reward_item");
   59:       out.mapCount = queryCount(connection, "SELECT COUNT(DISTINCT npc_file) FROM npc_quest_reference");
   60:       out.fashionCount = queryCount(connection, "SELECT COUNT(*) FROM quest_goal_getitem");
   61:     }
   62: 
```

#### 文件：`src/unluac\web\result\AdminQuestDetail.java`
- 类名：`AdminQuestDetail`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 11）：
```java
    9:   public Integer needLevel;
   10:   public Integer bqLoop;
   11:   public Integer rewardExp;
   12:   public Integer rewardGold;
   13:   public final List<String> contents = new ArrayList<String>();
```
- 相关代码片段（行 12）：
```java
   10:   public Integer bqLoop;
   11:   public Integer rewardExp;
   12:   public Integer rewardGold;
   13:   public final List<String> contents = new ArrayList<String>();
   14:   public final List<String> answer = new ArrayList<String>();
```

#### 文件：`src/unluac\web\result\AdminQuestListItem.java`
- 类名：`AdminQuestListItem`
- 方法名：`<class-level-or-init>`
- 结论：未发现处理逻辑（仅命中导入/字段/常量层）。
- 相关代码片段（行 7）：
```java
    5:   public String name;
    6:   public Integer needLevel;
    7:   public Integer rewardExp;
    8:   public Integer rewardGold;
    9:   public String recentModifiedAt;
```
- 相关代码片段（行 8）：
```java
    6:   public Integer needLevel;
    7:   public Integer rewardExp;
    8:   public Integer rewardGold;
    9:   public String recentModifiedAt;
   10: }
```

#### 文件：`src/unluac\web\service\AdminQuestService.java`
- 类名：`AdminQuestService`
- 方法名：`list`
- 相关代码片段（行 38）：
```java
   36:       ensureUpdatedAtColumn(connection, "quest_main");
   37:       out.total = count(connection, keyword);
   38:       String sql = "SELECT quest_id, name, need_level, reward_exp, reward_gold FROM quest_main"
   39:           + " WHERE (? IS NULL OR ? = '' OR name LIKE CONCAT('%', ?, '%') OR CAST(quest_id AS CHAR) LIKE CONCAT('%', ?, '%'))"
   40:           + " ORDER BY updated_at DESC, quest_id DESC LIMIT ? OFFSET ?";
```
- 相关代码片段（行 54）：
```java
   52:             item.name = rs.getString("name");
   53:             item.needLevel = getNullableInt(rs, "need_level");
   54:             item.rewardExp = getNullableInt(rs, "reward_exp");
   55:             item.rewardGold = getNullableInt(rs, "reward_gold");
   56:             item.recentModifiedAt = recentModifiedService.findQuestRecentModifiedAt(connection, item.questId);
```
- 相关代码片段（行 55）：
```java
   53:             item.needLevel = getNullableInt(rs, "need_level");
   54:             item.rewardExp = getNullableInt(rs, "reward_exp");
   55:             item.rewardGold = getNullableInt(rs, "reward_gold");
   56:             item.recentModifiedAt = recentModifiedService.findQuestRecentModifiedAt(connection, item.questId);
   57:             out.records.add(item);
```

#### 文件：`src/unluac\web\support\AdminRecentModifiedService.java`
- 类名：`AdminRecentModifiedService`
- 方法名：`findQuestRecentModifiedAt`
- 相关代码片段（行 19）：
```java
   17:         + " UNION ALL SELECT updated_at AS ts FROM quest_answer WHERE quest_id=?"
   18:         + " UNION ALL SELECT updated_at AS ts FROM quest_info WHERE quest_id=?"
   19:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_getitem WHERE quest_id=?"
   20:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_killmonster WHERE quest_id=?"
   21:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_meetnpc WHERE quest_id=?"
```
- 相关代码片段（行 20）：
```java
   18:         + " UNION ALL SELECT updated_at AS ts FROM quest_info WHERE quest_id=?"
   19:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_getitem WHERE quest_id=?"
   20:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_killmonster WHERE quest_id=?"
   21:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_meetnpc WHERE quest_id=?"
   22:         + " UNION ALL SELECT updated_at AS ts FROM quest_reward_item WHERE quest_id=?"
```
- 相关代码片段（行 21）：
```java
   19:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_getitem WHERE quest_id=?"
   20:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_killmonster WHERE quest_id=?"
   21:         + " UNION ALL SELECT updated_at AS ts FROM quest_goal_meetnpc WHERE quest_id=?"
   22:         + " UNION ALL SELECT updated_at AS ts FROM quest_reward_item WHERE quest_id=?"
   23:         + ") v";
```

## 步骤2：DB结构核对

### 2.1 entity/dao/mapper/schema.sql 扫描结果
- entity类：当前项目源码中未找到对应实现。
- dao类：当前项目源码中未找到对应实现。
- mapper类：仅发现语义类 `Phase25QuestNpcDependencyMapper`、`QuestRuntimeAstMapper`（非DB Mapper）。
- schema.sql：当前项目源码中未找到对应实现（未发现 `schema.sql` 文件）。

### 2.2 DB字段映射核对（按源码DDL）

#### 证据：Phase3建表与写入
```java
  142:     ddl.add("CREATE TABLE IF NOT EXISTS quest_main ("
  143:         + "quest_id INT NOT NULL PRIMARY KEY,"
  144:         + "name TEXT,"
  145:         + "need_level INT NOT NULL DEFAULT 0,"
  146:         + "bq_loop INT NOT NULL DEFAULT 0,"
  147:         + "reward_exp INT NOT NULL DEFAULT 0,"
  148:         + "reward_gold INT NOT NULL DEFAULT 0"
  149:         + ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci");
  178:     ddl.add("CREATE TABLE IF NOT EXISTS quest_goal_getitem ("
  179:         + "id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,"
  180:         + "quest_id INT NOT NULL,"
  181:         + "seq_index INT NOT NULL,"
  182:         + "item_id INT NOT NULL,"
  183:         + "item_count INT NOT NULL,"
  184:         + "UNIQUE KEY uk_goal_getitem (quest_id, seq_index),"
  185:         + "KEY idx_goal_getitem_quest (quest_id)"
  186:         + ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci");
  207:     ddl.add("CREATE TABLE IF NOT EXISTS quest_reward_item ("
  208:         + "id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,"
  209:         + "quest_id INT NOT NULL,"
  210:         + "seq_index INT NOT NULL,"
  211:         + "item_id INT NOT NULL,"
  212:         + "item_count INT NOT NULL,"
  213:         + "UNIQUE KEY uk_reward_item (quest_id, seq_index),"
  214:         + "KEY idx_reward_item_quest (quest_id)"
  267:     String insertMain = "INSERT INTO quest_main(quest_id, name, need_level, bq_loop, reward_exp, reward_gold) VALUES(?,?,?,?,?,?)";
  268:     String insertContents = "INSERT INTO quest_contents(quest_id, seq_index, text) VALUES(?,?,?)";
  269:     String insertAnswer = "INSERT INTO quest_answer(quest_id, seq_index, text) VALUES(?,?,?)";
  270:     String insertInfo = "INSERT INTO quest_info(quest_id, seq_index, text) VALUES(?,?,?)";
  271:     String insertGoalItem = "INSERT INTO quest_goal_getitem(quest_id, seq_index, item_id, item_count) VALUES(?,?,?,?)";
  272:     String insertGoalKill = "INSERT INTO quest_goal_killmonster(quest_id, seq_index, monster_id, monster_count) VALUES(?,?,?,?)";
  273:     String insertGoalMeet = "INSERT INTO quest_goal_meetnpc(quest_id, seq_index, npc_id) VALUES(?,?,?)";
  274:     String insertRewardItem = "INSERT INTO quest_reward_item(quest_id, seq_index, item_id, item_count) VALUES(?,?,?,?)";
```

| 检查项 | 是否存在 | 表 | 字段 | 类型 | 证据 |
|---|---|---|---|---|---|
| `reward_skill` | 否 | - | - | - | Phase3 DDL 未定义 `quest_reward_skill` |
| `reward_fame` | 否 | `quest_main` | - | - | `quest_main` 仅 `reward_exp/reward_gold` |
| `reward_pvppoint` | 否 | `quest_main` | - | - | 同上 |
| `reward_mileage` | 否 | `quest_main` | - | - | 同上 |
| `goal_get_item` | 部分（命名不一致） | `quest_goal_getitem` | `item_id`, `item_count` | `INT NOT NULL` | 存在近似表，非 `goal_get_item` 命名 |
| `npc_require_item` | 否 | - | - | - | 未发现表/字段映射 |

- 缺失字段：`reward_skill`、`reward_fame`、`reward_pvppoint`、`reward_mileage`、`npc_require_item`（按你要求的命名）。

## 步骤3：导出层核对（Phase4QuestLucExporter）

### 3.1 方法存在性
- `appendQuest()`：存在
- `appendReward()`：当前项目源码中未找到对应实现。
- `appendGoal()`：当前项目源码中未找到对应实现。

### 3.2 导出器源码证据
```java
  119:     try(Connection connection = DriverManager.getConnection(jdbcUrl, user, password)) {
  120:       String mainSql = "SELECT quest_id, name, need_level, bq_loop, reward_exp, reward_gold "
  121:           + "FROM quest_main ORDER BY quest_id ASC";
  122:       try(PreparedStatement ps = connection.prepareStatement(mainSql);
  123:           ResultSet rs = ps.executeQuery()) {
  124:         while(rs.next()) {
  125:           QuestRecord record = new QuestRecord();
  126:           record.questId = rs.getInt("quest_id");
  127:           record.name = rs.getString("name");
  128:           if(rs.wasNull()) {
  129:             record.name = null;
  130:           }
  131: 
  132:           record.needLevel = toNullableInt(rs, "need_level");
  133:           record.bqLoop = toNullableInt(rs, "bq_loop");
  134:           record.rewardExp = toNullableInt(rs, "reward_exp");
  135:           record.rewardGold = toNullableInt(rs, "reward_gold");
  136:           byQuest.put(Integer.valueOf(record.questId), record);
  137:         }
  138:       }
  139: 
  140:       loadStringArray(connection, byQuest, "quest_contents", ArrayType.CONTENTS);
  141:       loadStringArray(connection, byQuest, "quest_answer", ArrayType.ANSWER);
  142:       loadStringArray(connection, byQuest, "quest_info", ArrayType.INFO);
  143: 
  144:       loadPairArray(connection, byQuest, "quest_goal_getitem", "item_id", "item_count", PairType.GOAL_GET_ITEM);
  145:       loadPairArray(connection, byQuest, "quest_goal_killmonster", "monster_id", "monster_count", PairType.GOAL_KILL_MONSTER);
  146:       loadIntArray(connection, byQuest, "quest_goal_meetnpc", "npc_id");
  147:       loadPairArray(connection, byQuest, "quest_reward_item", "item_id", "item_count", PairType.REWARD_ITEM);
  266:   private void appendQuest(StringBuilder sb, QuestRecord quest) {
  267:     sb.append("qt[").append(quest.questId).append("] = {\n");
  268:     sb.append("  id = ").append(quest.questId).append(",\n");
  269:     sb.append("  name = ").append(luaStringOrNil(quest.name)).append(",\n");
  270:     sb.append("  contents = ");
  271:     appendStringArray(sb, quest.contents, 2);
  272:     sb.append(",\n");
  273:     sb.append("  answer = ");
  274:     appendStringArray(sb, quest.answer, 2);
  275:     sb.append(",\n");
  276:     sb.append("  info = ");
  277:     appendStringArray(sb, quest.info, 2);
  278:     sb.append(",\n");
  279: 
  280:     sb.append("  goal = {\n");
  281:     sb.append("    getItem = ");
  282:     appendPairArray(sb, quest.goalGetItem, 4, "id", "count");
  283:     sb.append(",\n");
  284:     sb.append("    killMonster = ");
  285:     appendPairArray(sb, quest.goalKillMonster, 4, "id", "count");
  286:     sb.append(",\n");
  287:     sb.append("    meetNpc = ");
  288:     appendIntArray(sb, quest.goalMeetNpc, 4);
  289:     sb.append("\n");
  290:     sb.append("  },\n");
  291: 
  292:     sb.append("  reward = {\n");
  293:     sb.append("    exp = ").append(luaIntOrNil(quest.rewardExp)).append(",\n");
  294:     sb.append("    gold = ").append(luaIntOrNil(quest.rewardGold)).append(",\n");
  295:     sb.append("    items = ");
  296:     appendPairArray(sb, quest.rewardItems, 4, "id", "count");
  297:     sb.append("\n");
  298:     sb.append("  },\n");
  299: 
  300:     sb.append("  needLevel = ").append(luaIntOrNil(quest.needLevel)).append(",\n");
  301:     sb.append("  bQLoop = ").append(luaIntOrNil(quest.bqLoop)).append("\n");
  302:     sb.append("}\n");
```

### 3.3 针对字段核对结论
- `reward.getSkill` 写出逻辑：未发现处理逻辑。
- `reward.fame` 写出逻辑：未发现处理逻辑。
- `reward.pvppoint` 写出逻辑：未发现处理逻辑。
- `reward.mileage` 写出逻辑：未发现处理逻辑。
- `goal.getItem` 写出逻辑：已发现（`appendPairArray(... quest.goalGetItem ...)`）。
- `npc.requstItem` 写出逻辑：未发现处理逻辑（Quest导出器未写该字段）。

## 步骤4：原始LUC结构对照

原始反编译文件：`reports/structure_audit_20260212_224450/questbak_decompiled.lua`

### 4.1 样本A（含 reward.getSkill）
```lua
 1598:   }
 1599: }).reward = {
 1600:   id = 22,
 1601:   name = "[ 剑-利刃术 ]",
 1602:   contents = {
 1603:     "利刃术，装备剑时，能使攻击力自动上升的内功武功。要学吗？",
 1604:     "ANSWER_YES:是的，我要学习。",
 1605:     "ANSWER_NO:我不要学习。",
 1606:     "学习过一次的武功，在使用武功还原符之前无法消除。好好考虑一下，决定后再和我说话吧。"
 1607:   },
 1608:   answer = {
 1609:     "嗯，我考虑一下。",
 1610:     "想都不用想，我不要学。"
 1611:   }
 1612: }, {
 1613:   getSkill = {10101}
 1614: }
```

### 4.2 样本B（含 goal.getItem）
```lua
   20: }).goal = {
   21:   getItem = {
   22:     {id = 8910031, count = 3}
   23:   }
   24: }
```

### 4.3 样本C（含 requstItem）
```lua
   77: }).requstItem = {
   78:   {
   79:     meetcnt = 0,
   80:     itemid = 8990002,
   81:     itemcnt = 1
   82:   }
   83: }
```

### 4.4 样本对照结论（DB / Java实体 / 导出器）
| 样本字段 | 数据库是否完整表示 | Java实体是否完整表示 | 导出器是否完整写回 | 结论 |
|---|---|---|---|---|
| `reward.getSkill` | 否（Phase3无 `quest_reward_skill`） | 部分（`QuestSemanticModel.Reward.skillIds` 存在） | 否（Phase4未写 `getSkill`） | 存在丢失风险 |
| `goal.getItem` | 是（`quest_goal_getitem`） | 是（`QuestGoal.items` + Phase2映射） | 是（Phase4 `goal.getItem` 写出） | 基本完整 |
| `requstItem` | 否（无对应表/列） | 部分（Extractor提取到 `conditions`） | 否（Phase4未写 `requstItem`） | 存在丢失风险 |

#### 证据：Extractor/Phase2对上述字段处理
```java
   36:   private static final Set<String> QUEST_KEYS = new LinkedHashSet<String>();
   37:   private static final Set<String> DIALOG_KEYS = new LinkedHashSet<String>();
   38:   private static final Set<String> REWARD_KEYS = new LinkedHashSet<String>();
   39:   private static final Set<String> CONDITION_KEYS = new LinkedHashSet<String>();
   40: 
   41:   static {
   42:     QUEST_KEYS.add("id");
   43:     QUEST_KEYS.add("name");
   44:     QUEST_KEYS.add("contents");
   45:     QUEST_KEYS.add("answer");
   46:     QUEST_KEYS.add("info");
   47:     QUEST_KEYS.add("npcsay");
   48:     QUEST_KEYS.add("needLevel");
   49:     QUEST_KEYS.add("needQuest");
   50:     QUEST_KEYS.add("goal");
   51:     QUEST_KEYS.add("reward");
   52:     QUEST_KEYS.add("requstItem");
   53: 
   54:     DIALOG_KEYS.add("contents");
   55:     DIALOG_KEYS.add("answer");
   56:     DIALOG_KEYS.add("info");
   57:     DIALOG_KEYS.add("npcsay");
   58: 
   59:     REWARD_KEYS.add("money");
   60:     REWARD_KEYS.add("exp");
   61:     REWARD_KEYS.add("fame");
   62:     REWARD_KEYS.add("pvppoint");
   63:     REWARD_KEYS.add("getSkill");
   64:     REWARD_KEYS.add("id");
   65:     REWARD_KEYS.add("count");
   66:     REWARD_KEYS.add("itemid");
   67:     REWARD_KEYS.add("itemcnt");
   68: 
   69:     CONDITION_KEYS.add("needLevel");
   70:     CONDITION_KEYS.add("needQuest");
   71:     CONDITION_KEYS.add("requstItem");
   72:     CONDITION_KEYS.add("goal");
   73:     CONDITION_KEYS.add("killMonster");
   74:     CONDITION_KEYS.add("getItem");
  799:       Value requestItem = table.fields.get("requstItem");
  800:       if(requestItem != null) {
  801:         putCondition(model.conditions, "requstItem", toObject(requestItem, 0, new HashSet<Integer>()));
  802:         fillQuestItemRequirements(model.goal, requestItem);
  803:         state.ruleHits.add(new RuleHit(
  804:             RULE_CONDITION,
  805:             table.functionPath,
  806:             table.createPc,
  807:             table.createOffset,
  808:             "questId=" + questId + " condition=requstItem"));
 1434:       if("fame".equals(key)) {
 1435:         Integer number = value == null ? null : value.asInteger();
 1436:         if(number != null) {
 1437:           reward.fame = number.intValue();
 1438:           if("table".equals(reward.type)) {
 1439:             reward.type = "fame";
 1440:           }
 1441:         }
 1442:         continue;
 1443:       }
 1444:       if("pvppoint".equals(key)) {
 1445:         Integer number = value == null ? null : value.asInteger();
 1446:         if(number != null) {
 1447:           reward.pvppoint = number.intValue();
 1448:           if("table".equals(reward.type)) {
 1449:             reward.type = "pvppoint";
 1450:           }
 1451:         }
 1452:         continue;
 1453:       }
 1454:       if("exp".equals(key)) {
 1455:         Integer number = value == null ? null : value.asInteger();
 1456:         if(number != null) {
 1457:           reward.exp = number.intValue();
 1458:           if("table".equals(reward.type)) {
 1459:             reward.type = "exp";
 1460:           }
 1461:         }
 1462:         continue;
 1463:       }
 1464:       if("getSkill".equals(key)) {
 1465:         if(value != null) {
 1466:           reward.skillIds.addAll(extractIntegerLeaves(value, 0, new HashSet<Integer>()));
 1467:           if(!reward.skillIds.isEmpty() && "table".equals(reward.type)) {
 1468:             reward.type = "skill";
  328:   private void fillReward(QuestRecord record, QuestSemanticModel model) {
  329:     if(record == null || model == null || model.rewards == null) {
  330:       return;
  331:     }
  332:     for(QuestSemanticModel.Reward reward : model.rewards) {
  333:       if(reward == null) {
  334:         continue;
  335:       }
  336:       record.reward.exp += reward.exp;
  337:       record.reward.gold += reward.money;
  338:       if(reward.id > 0 && reward.count > 0) {
  339:         RewardItem item = new RewardItem();
  340:         item.id = reward.id;
  341:         item.count = reward.count;
  342:         record.reward.items.add(item);
  343:       }
 1844: 
 1845:   private static final class RewardBlock {
 1846:     int exp;
 1847:     int gold;
 1848:     final List<RewardItem> items = new ArrayList<RewardItem>();
 1849: 
 1850:     String toJson() {
 1851:       StringBuilder sb = new StringBuilder();
 1852:       sb.append("{")
 1853:           .append("\"exp\":").append(exp).append(",")
 1854:           .append("\"gold\":").append(gold).append(",")
 1855:           .append("\"items\":").append(jsonRewardItems(items))
 1856:           .append("}");
 1857:       return sb.toString();
 1858:     }
 1859:   }
 1860: 
  731:     if("reward".equalsIgnoreCase(layer)) {
  732:       if("exp".equals(low) || "fame".equals(low) || "money".equals(low) || "pvppoint".equals(low) || "mileage".equals(low)) {
  733:         return "Identity";
```

## 步骤5：一致性结论

1. 哪些字段完全支持？
- `quest.goal.getItem`（Extractor -> Phase2 -> Phase3 -> Phase4 全链路可见）。
- `quest.goal.killMonster`（同上）。
- `quest.reward.exp`（写入 `reward_exp`，可导出）。

2. 哪些字段部分支持？
- `quest.reward.getItem`：当前链路使用 `reward.items` 表达，不保留原键名 `getItem`。
- `quest.reward.money`：Extractor识别 `money`，Phase2/3/4 转换为 `gold` 输出，存在语义映射差异。
- `npc.goal.getItem`：代码层有扫描/引用分析能力，但无NPC脚本结构化入库映射。

3. 哪些字段完全缺失？
- `quest.reward.getSkill`（DB和导出层缺失）。
- `quest.reward.fame`（DB和导出层缺失）。
- `quest.reward.pvppoint`（DB和导出层缺失）。
- `quest.reward.mileage`（除覆盖扫描器分类外，主链路未发现处理逻辑）。
- `npc.requstItem`（未发现对应DB映射与导出写回）。

4. 是否存在语义歧义（goal.getItem vs reward.getItem 混淆）？
- 存在。当前实现使用 `goal.getItem` 与 `reward.items`，原始脚本可能出现 `reward.getItem/getitem` 形态，键名层面存在归一化歧义。

5. 是否存在数据丢失风险？
- 存在，评级：HIGH。`getSkill/fame/pvppoint/mileage/requstItem` 在当前 DB->导出链路存在缺口。

6. 是否存在导出后结构变化风险？
- 存在，评级：HIGH。已观察到 `money -> gold`、`reward.getItem -> reward.items` 的结构/键名变化风险。

## 风险评级

- 总体风险：**HIGH**
- 关键原因：奖励与条件扩展字段在入库/导出链路不完整，字段语义存在键名归一化差异。

